name: Release & Deploy

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  # Reuse CI checks
  ci-checks:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: ci-checks
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag-version: ${{ steps.get-version.outputs.tag-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get versions
        id: get-version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          MANIFEST_VERSION=$(node -p "require('./manifest.json').version")

          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "tag-version=$TAG_VERSION" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Versions:"
          echo "  Tag: v$TAG_VERSION"
          echo "  package.json: $PACKAGE_VERSION"
          echo "  manifest.json: $MANIFEST_VERSION"

      - name: Validate version consistency
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          MANIFEST_VERSION=$(node -p "require('./manifest.json').version")

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Tag version ($TAG_VERSION) doesn't match package.json ($PACKAGE_VERSION)"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "âŒ Tag version ($TAG_VERSION) doesn't match manifest.json ($MANIFEST_VERSION)"
            exit 1
          fi

          echo "âœ… All versions match: $TAG_VERSION"

      - name: Check changelog entry
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if ! grep -q "\[$TAG_VERSION\]" CHANGELOG.md; then
            echo "âš ï¸  Warning: No changelog entry found for version $TAG_VERSION"
            echo "Please update CHANGELOG.md before releasing"
            exit 1
          fi
          echo "âœ… Changelog entry exists for $TAG_VERSION"

  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Create release bundle
        run: |
          mkdir -p release
          cp manifest.json release/
          cp -r dist release/

          cd release
          zip -r ../plugin-bundle.zip .
          cd ..

      - name: Generate checksums
        run: |
          sha256sum plugin-bundle.zip > plugin-bundle.zip.sha256
          sha256sum dist/code.js > dist-code.js.sha256
          sha256sum dist/index.html > dist-index.html.sha256

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            plugin-bundle.zip
            plugin-bundle.zip.sha256
            dist-code.js.sha256
            dist-index.html.sha256

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-release]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ needs.validate-release.outputs.tag-version }}"

          # Create installation instructions header
          cat > release-notes.md <<'HEADER'
          ## ðŸ“¦ Installation Instructions

          **âš ï¸ IMPORTANT: Download `plugin-bundle.zip` from the Assets section below, NOT the source code archives!**

          ### To install this plugin in Figma:
          1. Download **`plugin-bundle.zip`** from the Assets section below
          2. Extract the ZIP file
          3. In Figma: Menu â†’ Plugins â†’ Development â†’ Import plugin from manifest...
          4. Select the `manifest.json` file from the extracted folder

          ---

          ## ðŸ“ Changes in this Release

          HEADER

          # Extract the section for this version from CHANGELOG.md
          awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | head -n -1 >> release-notes.md

          if ! grep -q "^### " release-notes.md && ! grep -q "^- " release-notes.md; then
            echo "" >> release-notes.md
            echo "See CHANGELOG.md for full details." >> release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ needs.validate-release.outputs.tag-version }}
          body_path: release-notes.md
          files: |
            plugin-bundle.zip
            plugin-bundle.zip.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Dropbox deployment disabled for now - use manual deployment script if needed
  # See scripts/deploy-to-dropbox.sh for manual deployment
  # deploy-to-dropbox:
  #   ...

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate-release, create-github-release]
    if: always() && needs.validate-release.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare notification message
        id: message
        run: |
          VERSION="${{ needs.validate-release.outputs.tag-version }}"
          STATUS="success"
          EMOJI="ðŸš€"
          STATUS_TEXT="Successfully released"

          # Extract recent changes from changelog
          awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | head -n -1 | tail -n +2 > changes.txt

          cat > notification.txt <<EOF
          $EMOJI New Tidy DS Toolbox Release: v$VERSION

          $STATUS_TEXT

          ðŸ“ Changes:
          $(cat changes.txt | head -n 10)

          ðŸ“¦ Installation:
          1. Go to: https://github.com/${{ github.repository }}/releases/tag/v$VERSION
          2. Download plugin-bundle.zip (NOT the source code archives!)
          3. Extract and import to Figma via: Plugins â†’ Development â†’ Import plugin from manifest

          ðŸ“– Full Changelog: https://github.com/${{ github.repository }}/releases/tag/v$VERSION
          EOF

          cat notification.txt

      - name: Post to Slack
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$(cat notification.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')\"}"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸš€ Release v${{ needs.validate-release.outputs.tag-version }} Complete

          ## Status
          - âœ… CI Checks Passed
          - âœ… GitHub Release Created
          - ðŸ“¦ Manual deployment available via scripts/deploy-to-dropbox.sh

          ## Quick Links
          - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-release.outputs.tag-version }})
          - [View Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          - [Download Plugin Bundle](https://github.com/${{ github.repository }}/releases/download/v${{ needs.validate-release.outputs.tag-version }}/plugin-bundle.zip)

          ## Next Steps
          - Download **plugin-bundle.zip** (not the source code archives!)
          - Extract and share with team for Figma import
          - Or use \`./scripts/deploy-to-dropbox.sh\` to deploy automatically

          ## Installation Instructions for Users
          1. Download **plugin-bundle.zip** from the release assets
          2. Extract the ZIP file
          3. In Figma: Plugins â†’ Development â†’ Import plugin from manifest...
          4. Select the \`manifest.json\` file from the extracted folder
          EOF
